---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# smoothedIPW

<!-- badges: start -->
[![R-CMD-check](https://github.com/stmcg/smoothedIPW/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/stmcg/smoothedIPW/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The `smoothedIPW` package implements methods to estimate effects of generalized time-varying treatment strategies on the mean of an outcome at one or more selected follow-up times of interest. The package allows for treatment strategies with the following components:

- Initiate treatment $z$ at baseline
- Follow a user-specified time-varying adherence protocol for treatment $z$
- Ensure an outcome measurement at the follow-up time of interest.

The package considers the setting where outcomes may be repeatedly, non-monotonically, informatively, and sparsely measured in the data source. The package also supports settings where outcomes are truncated by death, i.e. some individuals die during follow-up which renders the outcome of interest undefined at the follow-up time of interest.

Specifically, this package implements the time-smoothed inverse probability weighted (IPW) methods described in [McGrath et al. (2025)](https://doi.org/10.48550/arXiv.2509.13971). Time-smoothing refers to using outcome measurements at intermediate time-points in order to gain precision. In settings with truncation by death, two different type of approaches for time-smoothing are available (i.e., the stacked and nonstacked methods), which rely on different model assumptions. Further details are given in [McGrath et al. (2025)](https://doi.org/10.48550/arXiv.2509.13971).

## Installation

You can install the development version of `smoothedIPW` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("stmcg/smoothedIPW")
```

## Example

We first load the package.
```{r}
library(smoothedIPW)
```

We will estimate the effect of treatment strategies with the following three components:
* Initiate medication $z$ ($z \in \{0, 1\}$) at baseline
* Adhere to medication $z$ throughout the follow up, allowing for a grace period of 2 months
* Ensure an outcome measurement at the follow-up time of interest

We consider the follow-up time of interest to be $t^*$, $t^* \in \{6, 12, 18, 24\}$. In this example, we consider that there are no deaths over the study period. See the package help files for examples with deaths over the study period.

#### Data Set 

We will use the example data set `data_null` which contains longitudinal data on 1,000 individuals over 25 time points. This data set was generated so that the treatment has no effect on the outcome at all time points. The data set `data_null` contains the following columns: 

* `id`: Participant ID
* `time`: Follow-up time index
* `L`: Time-varying covariate
* `Z`: Medication initiated at baseline
* `A`: Adherence to the medication initiated at baseline
* `R`: Indicator of outcome measurement
* `Y`: Outcome

The first 10 rows of `data_null` are: 
```{r}
data_null[1:10,]
```

The package generally expects users to follow these naming conventions for the columns of the observed data set. The columns for the time-varying covariate(s) are an exception to this, which can take on any names. 

#### Applying IPW

###### Preparing the data set

We first need to add some variables to the data set before applying inverse probability weighting. Specifically, we need to add:

* `C_artificial`: An indicator specifying when an individual should be artificially censored from the data
* `A_model_eligible`: An indicator specifying what records should be used for fitting the treatment adherence model

We will also need to add columns for the baseline value of the time-varying covariates. In our case, we will add a column `L_baseline` for the baseline value of `L`.

These columns can be added by the `prep_data` function, as shown below:
```{r}
data_null_processed <- prep_data(data = data_null, grace_period_length = 2,
                                 baseline_vars = 'L')
data_null_processed[id == 2,]
```


###### Point estimation

We will use the time-smoothed IPW method, which is implemented in the `ipw` function. This method involves specifying the following models:

* `A_model`: Treatment adherence model
* `R_model_denominator`: Outcome measurement indicator model (used in the denominator of weights)
* `R_model_numerator`: (Optional) Outcome measurement indicator model (used in the numerator of weights for stabilization)
* `Y_model`: Outcome (marginal structural) model

An example application of `ipw` is below:
```{r}
res_est <- ipw(data = data_null_processed,
               time_smoothed = TRUE,
               outcome_times = c(6, 12, 18, 24),
               A_model = A ~ L + Z,
               R_model_denominator = R ~ L + A + Z,
               R_model_numerator = R ~ L_baseline + Z,
               Y_model = Y ~ L_baseline * (time + Z))
```

The estimated counterfactual outcome mean for each medication at each follow-up time of interest ($t^*$) is given below.
```{r}
res_est
```


###### Interval estimation

To obtain 95\% confidence intervals around our estimates, we can apply the `get_CI` function. It constructs percentile-based bootstrap confidence intervals using `n_boot` bootstrap replicates. We use 10 bootstrap replicates for ease of computation.

```{r}
set.seed(1234)
res_ci <- get_CI(res_est, data = data_null_processed, n_boot = 10)
res_ci$res_boot
```
